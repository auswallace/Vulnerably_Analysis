---
title: "Vulnerability Quick Analysis"
output:
  html_document:
    df_print: paged
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
  word_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(stargazer)
library(readr)
library(gganimate)
library(tidyverse)
library(lubridate)
library(dplyr)
```


```{r}
library(readr)

# Correct GitHub Raw URL
github_raw_url <- "https://raw.githubusercontent.com/auswallace/Vulnerably_Analysis/main/device_vuln_data_20250202_134935.csv"

# Read CSV with Explicit Column Types
df <- read_csv(github_raw_url, col_types = cols(
  device_id = col_character(),
  device_name = col_character(),
  ip_address = col_character(),
  os = col_character(),
  device_type = col_character(),
  scan_date = col_date(format = "%Y-%m-%d"),
  vulnerability_id = col_character(),
  cve_publish_date = col_date(format = "%Y-%m-%d"),
  plugin_id = col_double(),
  cvss_score = col_double(),
  risk_score = col_double(),
  exploit_available = col_character(),
  patch_available = col_character(),
  compliance_issue = col_character(),
  vulnerability_age = col_double()
))

head(df)

# Basic summary statistics
summary(df)


```
### Exploratory Data Analysis


#### Missing field check
```{r missing-values}
# Count missing values in each column
df %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "column", values_to = "missing_count") %>%
  filter(missing_count > 0)

```


#### Risk Score Distribution
```{r risk-score dist}
# Histogram of risk scores
ggplot(df, aes(x = risk_score)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of Risk Scores", x = "Risk Score", y = "Count") +
  theme_minimal()
```


#### OS by Risk
- Identifies which OS versions are most vulnerable on average.
- Useful for prioritizing remediation by OS type.
```{r top-os-risk, fig.width=7, fig.height=5}
# Average risk score per OS
df %>%
  group_by(os) %>%
  summarise(avg_risk = mean(risk_score, na.rm = TRUE), count = n()) %>%
  arrange(desc(avg_risk)) %>%
  ggplot(aes(x = reorder(os, avg_risk), y = avg_risk, fill = os)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  labs(title = "Average Risk Score by OS", x = "Operating System", y = "Average Risk Score") +
  theme_minimal()

```

#### Patch Availability vs. Risk Score
- Do patched vulnerabilities tend to have lower risk scores?
- Could indicate whether patches are being applied effectively.

```{r patch-vs-risk, fig.width=7, fig.height=5}
ggplot(df, aes(x = patch_available, y = risk_score, fill = patch_available)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Patch Availability vs. Risk Score", x = "Patch Available", y = "Risk Score") +
  theme_minimal()

```

#### CVSS Scores 


```{r cvss-score-analysis, fig.width=12, fig.height=10, message=FALSE, warning=FALSE}
# Load necessary libraries
library(ggplot2)
library(patchwork)  # For combining multiple plots

# Histogram of CVSS Scores
p1 <- ggplot(df, aes(x = cvss_score)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of CVSS Scores", x = "CVSS Score", y = "Count") +
  theme_minimal()

# Boxplot of CVSS Scores by OS
p2 <- ggplot(df, aes(x = os, y = cvss_score, fill = os)) +
  geom_boxplot(alpha = 0.7) +
  coord_flip() +
  labs(title = "CVSS Score Distribution by Operating System", x = "Operating System", y = "CVSS Score") +
  theme_minimal()

# Scatter Plot: CVSS vs. Risk Score
p3 <- ggplot(df, aes(x = cvss_score, y = risk_score)) +
  geom_point(alpha = 0.5, color = "blue") +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  labs(title = "CVSS Score vs. Risk Score", x = "CVSS Score", y = "Risk Score") +
  theme_minimal()

# Combine all plots using patchwork
(p1 / p2) | p3
```

### Analysis 1

#### Top 10 Most Pervasive Vulnerabilities
This will identify vulnerabilities that are:

Most frequently occurring (high count in dataset)
Highest risk impact (based on total risk_score)

```{r top-vulnerabilities, message=FALSE}
library(dplyr)
library(gt)

# Aggregate by vulnerability ID
top_vulns <- df %>%
  group_by(vulnerability_id) %>%
  summarise(
    count = n(),
    avg_risk = mean(risk_score, na.rm = TRUE),
    total_risk = sum(risk_score, na.rm = TRUE)
  ) %>%
  arrange(desc(count), desc(total_risk)) %>%
  head(10)

# Format table using gt
top_vulns %>%
  gt() %>%
  tab_header(
    title = "Top 10 Most Pervasive Vulnerabilities",
    subtitle = "Ranked by Occurrence & Total Risk"
  ) %>%
  fmt_number(columns = c(avg_risk, total_risk), decimals = 2) %>%
  cols_label(
    vulnerability_id = "Vulnerability ID",
    count = "Occurrence Count",
    avg_risk = "Average Risk Score",
    total_risk = "Total Risk Score"
  )
```


#### Top 10 Riskiest Workstations

```{r prepare-top-workstations, include=FALSE}
top_workstations <- df %>%
  filter(device_type == "Workstation") %>%
  group_by(device_id, device_name, os) %>%
  summarise(
    total_risk = sum(risk_score, na.rm = TRUE),
    avg_risk = mean(risk_score, na.rm = TRUE),
    vuln_count = n(),
    .groups = "drop"
  ) %>%
  arrange(desc(total_risk)) %>%
  slice_head(n = 10)  # Ensures exactly 10 rows
```

```{r top-risky-workstations, message=FALSE}
library(gt)

top_workstations %>%
  mutate(Rank = row_number()) %>%
  gt() %>%
  tab_header(
    title = "üî¥ Top 10 Riskiest Workstations",
    subtitle = "Ranked by Total Risk Score"
  ) %>%
  fmt_number(columns = c(total_risk, avg_risk), decimals = 2)
```



#### Top 10 Riskiest Servers

```{r prepare-top-servers, include=FALSE}
top_servers <- df %>%
  filter(device_type == "Server") %>%
  group_by(device_id, device_name, os) %>%
  summarise(
    total_risk = sum(risk_score, na.rm = TRUE),
    avg_risk = mean(risk_score, na.rm = TRUE),
    vuln_count = n(),
    .groups = "drop"
  ) %>%
  arrange(desc(total_risk)) %>%
  slice_head(n = 10)  # Ensures exactly 10 rows
```

```{r top-risky-servers, message=FALSE}
library(gt)

top_servers %>%
  mutate(Rank = row_number()) %>%
  gt() %>%
  tab_header(
    title = "üî¥ Top 10 Riskiest Servers",
    subtitle = "Ranked by Total Risk Score"
  ) %>%
  fmt_number(columns = c(total_risk, avg_risk), decimals = 2)
```

###Analysis 2: Patch Effectiveness & Compliance Gaps

#### Key Questions:
- Are high-risk vulnerabilities being left unpatched?
- Do compliance issues correlate with longer vulnerability exposure?
- Which OS types or device categories have the worst patch adoption?
- How long does it take for vulnerabilities to be patched after discovery?


####1) Risk Scores vs. Patch Availability - Are Critical Vulns Being Patched 
Hypothesis: If high-risk vulnerabilities (CVSS 9+) are left unpatched, security posture is weak.

- Boxplot: risk_score vs. patch_available
- Statistical Test: Use Wilcoxon rank-sum test to check if patched vs. unpatched vulnerabilities have significantly different risk_score distributions.
- Actionable Insight: If unpatched vulnerabilities have higher risk, then remediation should focus on high-priority patches first.


```{r patch-vs-risk-score, fig.width=7, fig.height=5, error = FALSE}
# Boxplot of Risk Score vs. Patch Availability
ggplot(df, aes(x = patch_available, y = risk_score, fill = patch_available)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Patch Availability vs. Risk Score", x = "Patch Available?", y = "Risk Score") +
  theme_minimal()

# Wilcoxon Test: Are patched vulnerabilities significantly lower in risk?
wilcox.test(risk_score ~ patch_available, data = df)
```
Since p = 0.4803 > 0.05, the test suggests that there isn‚Äôt a meaningful difference in risk scores between patched and unpatched vulnerabilities.
- This means that patching does not seem to correlate with risk reduction in this dataset.
- Possible explanations:
- Patches may not be applied strategically (i.e., teams are patching low-risk vulnerabilities as often as high-risk ones).
- High-risk vulnerabilities remain unpatched at the same rate as lower-risk ones.
- Risk score calculation doesn‚Äôt factor in patching effectiveness.




#### Compliance Issues vs. Risk Score - Do Non-Compliant Devices Have Higher Risk?
üîç Hypothesis: Non-compliant devices (security misconfigurations, missing controls) have higher risk scores.

- Boxplot: risk_score vs. compliance_issue
- Chi-Square Test: Check if non-compliant devices have more high-risk vulnerabilities
- Actionable Insight: If non-compliance is a strong predictor of risk, then compliance enforcement should be prioritized.
```{r compliance-vs-risk-score, fig.width=7, fig.height=5}
# Boxplot of Compliance Issues vs. Risk Score
ggplot(df, aes(x = compliance_issue, y = risk_score, fill = compliance_issue)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Compliance Issues vs. Risk Score", x = "Compliance Issue?", y = "Risk Score") +
  theme_minimal()

# Chi-Square Test: Are compliance issues correlated with high risk?
table_compliance <- table(df$compliance_issue, df$risk_score > 500)
chisq.test(table_compliance)
```

Compliance issues do not appear to be a predictor of higher risk scores.
- This suggests that both compliant and non-compliant devices have similar levels of risk in your dataset.
- Possible explanations:
- Compliance flags might not be capturing true security risk.
- The definition of "compliance issue" might be too broad to show a clear relationship with risk.
- Some compliant devices could still have high-risk vulnerabilities, and some non-compliant ones might be low-risk.



```{r patching-delay-analysis, fig.width=7, fig.height=5, warning= FALSE, error = FALSE}
library(survival)
library(survminer)

# Calculate patching delay
df$patching_delay <- as.numeric(df$scan_date - df$cve_publish_date)

# Density Plot: How long does it take to patch vulnerabilities?
ggplot(df, aes(x = patching_delay, fill = patch_available)) +
  geom_density(alpha = 0.7) +
  labs(title = "Patching Delay Distribution", x = "Days Until Patch", y = "Density") +
  theme_minimal()

# Survival Analysis: Probability of remaining unpatched over time
surv_obj <- Surv(df$patching_delay, df$patch_available == "Yes")
km_fit <- survfit(surv_obj ~ 1)
ggsurvplot(km_fit, data = df, title = "Survival Curve of Unpatched Vulnerabilities")
```



### Analysis 2: Risk Score Heatmap - Identifying High-Risk Device Clusters
Key Questions
- Wich devices are most at risk based on cumulative risk score?
- Are there clusters of high-risk devices that need immediate attention?
- Are certain OS types or device groups contributing disproportionately to risk?



#### Heatmap of Risk Scores Across Devices & OS
Hypothesis: Certain OS types or devices have more critical vulnerabilities.

- Heatmap of risk_score by device_id & os
- Hierarchical Clustering: Identify groups of high-risk devices
- Actionable Insight: If specific OS types dominate risk, security teams should prioritize those for patching.

```{r risk-score-heatmap, fig.width=8, fig.height=6, error=FALSE, warning=FALSE}
library(reshape2)

# Aggregate risk scores per device
risk_matrix <- df %>%
  group_by(device_id, os) %>%
  summarise(total_risk = sum(risk_score, na.rm = TRUE)) %>%
  acast(device_id ~ os, value.var = "total_risk", fill = 0)

# Heatmap of risk scores by device and OS
heatmap(risk_matrix, scale = "row", col = terrain.colors(10), main = "Heatmap of Device Risk Scores")
```

#### Clustering Devices by Risk Level
üîç Hypothesis: Some devices are persistently high-risk and should be isolated or prioritized.

- Use K-Means Clustering to segment devices into low, medium, and high risk
- Visualize Clusters: Scatter plot with kmeans() labels
- Actionable Insight: If certain clusters have high-risk servers, isolate or segment them.


```{r device-clustering, fig.width=7, fig.height=5}
# Prepare data for clustering
df_cluster <- df %>%
  group_by(device_id) %>%
  summarise(avg_risk = mean(risk_score, na.rm = TRUE))

# Apply K-Means clustering
set.seed(42)
kmeans_result <- kmeans(df_cluster$avg_risk, centers = 3)

# Scatter Plot of Clusters
df_cluster$cluster <- as.factor(kmeans_result$cluster)
ggplot(df_cluster, aes(x = device_id, y = avg_risk, color = cluster)) +
  geom_point(size = 3) +
  labs(title = "Device Risk Clustering", x = "Device ID", y = "Average Risk Score") +
  theme_minimal()
```







